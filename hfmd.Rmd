---
title: "Hand-foot-and-mouth disease"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Constants

Data folder:

```{r}
data_folder <- paste0("~/Library/CloudStorage/OneDrive-OxfordUniversityClinicalResearchUnit/",
                      "GitHub/OUCRU-Modelling/hfmd/")
```


## Packages

```{r message = FALSE}
library(readxl)
library(dplyr)
library(stringr)
library(purrr)
library(tidyr)
library(lubridate)
library(magrittr)
```


## Functions

A function that reads the excel files:

```{r}
read_excel2 <- function(x, ...) {
  out <- readxl::read_excel(paste0(data_folder, x), skip = 1, ...)
  out |>
    names() |>
    str_remove("^.*\r*\n\\(") |>
    str_remove("\\)") |>
    str_replace("...12", "month") |>
    str_replace("...13", "year") %>%
    setNames(out, .) |> 
    filter(! is.na(Participant_No))
}
```

A tuning of the `polygon()` function:

```{r}
polygon2 <- function(x, y1, y2, ...) {
  polygon(c(x, rev(x)), c(y1, rev(y2)), ...)
}
```

The function that performs a likelihood ratio test:

```{r}
lrt <- function(...) anova(..., test = "LRT")
```

A tuning of the `points()` function:

```{r}
points2 <- function(...) points(..., pch = "|", cex = .5)
```


## Loading data

```{r, message = FALSE}
sero <- data_folder |>
  dir() |> 
  map_dfr(read_excel2) |> 
  mutate(across(Neutralization, ~ .x == "Yes")) |> 
  replace_na(list(Neutralization = FALSE)) |> 
  mutate(collection_date = ymd(paste(year, month, `Day of taking blood sample`, sep = ":"))) |> 
  select(- `Day of taking blood sample`) |> 
  mutate(across(`Serum dilution`, ~ str_remove(.x, "1:") |> as.integer())) |> 
  rename(age = `Exact age calculated`, neutralization = Neutralization)
```


## A polynomial logistic model

A function that computes a model's predictions:

```{r}
predict2 <- function(x, ci = .95, le = 512, m = 100) {
  p <- (1 - ci) / 2
  
  link_inv <- x$family$linkinv
  dataset <- x$data
  n <- nrow(dataset) - length(x$coefficients)
  age_range <- range(dataset$age)
  
  ages <- seq(age_range[1], age_range[2], le = le)
  
  x |> 
    predict(data.frame(age = ages), se.fit = TRUE) |> 
    extract(c("fit", "se.fit")) %>%
    c(age = list(ages), .) |>
    as_tibble() |> 
    mutate(lwr = m * link_inv(fit + qt(    p, n) * se.fit),
           upr = m * link_inv(fit + qt(1 - p, n) * se.fit),
           fit = m * link_inv(fit)) |> 
    select(- se.fit)
}
```

A function that plots a model's predictions:

```{r}
plot_predictions <- function(x, add = FALSE, col = 4, alpha = .2, lwd = 2, m = 100) {
  with(x, {
    if (! add) {
      plot(NA, xlim = c(0, max(age)), ylim = c(0, m),
           xlab = "age (year)", ylab = "seroprevalence (%)")
    }
    polygon2(age, lwr, upr, border = NA, col = adjustcolor(col, alpha))
    lines(age, fit, col = col, lwd = lwd)
  })
}
```

A function that generates a polynomial formula:

```{r}
make_formula <- function(degree) {
  2:degree |>
    map_chr(~ paste("I(age ^", .x, ")")) |> 
    paste(collapse = " + ") %>%
    paste("neutralization ~ age +", .) |> 
    as.formula()
}
```

A function that helps looking for the optimal degree of the polynomial:

```{r}
test_degrees <- function(year, degree) {
  make_formula(degree) |> 
    glm(binomial, filter(sero, year == as.character(year))) |> 
    lrt()
}
```

Looking for optimal degrees for the 2 years:

```{r}
test_degrees(2022, 5)
test_degrees(2023, 5)
```

Looking for year effects:

```{r}
lrt(glm(neutralization ~ age * year + I(age ^2) * year, binomial, sero))
```

Best final model is then:

```{r}
m <- 100
eps <- 1

glm(neutralization ~ age + I(age ^2), binomial, filter(sero, year == "2022")) |> 
  predict2() |> 
  plot_predictions()

glm(neutralization ~ age + I(age ^2), binomial, filter(sero, year == "2023")) |> 
  predict2() |> 
  plot_predictions(add = TRUE, col = 2)

sero |>
  filter(year == "2022") |> 
  with(points2(age, m * neutralization + eps, col = 4))

sero |>
  filter(year == "2023") |> 
  with(points2(age, m * neutralization - eps, col = 2))
```
